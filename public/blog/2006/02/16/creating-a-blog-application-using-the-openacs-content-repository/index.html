<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

    
    
    
    <link href="//fonts.googleapis.com/css?family=Quattrocento:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Quattrocento+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    
    

    
    <title>Creating a Blog Application using the OpenACS Content Repository</title>

    
    
    <link rel="stylesheet" href="/css/hugo-octopress.css">

    
    

    
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
    

    
    <link href="https://kurup.org/favicon.ico" rel="icon">

    
    

    <meta name="description" content="" />
    <meta name="keywords" content="">
    <meta name="author" content="Vinod Kurup">

    
    <meta name="generator" content="Hugo 0.59.1" />

    
    

    
    
  </head>
  <body>

    
    <header role="banner">
<hgroup>
  
  <h1><a href="https://kurup.org/">Vinod Kurup</a></h1>
    <h2>Hospitalist/programmer in search of the meaning of life</h2>
</hgroup></header>

    
    <nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
    
    <option value="https://kurup.org/">» Blog</option>
    
    <option value="https://kurup.org/about">» About Me</option>
    
    <option value="https://kurup.org/post">» Archives</option>
    
    <option value="https://kurup.org/categories">» Categories</option>
    
    <option value="https://kurup.org/medicine">» Medicine</option>
    
    <option value="https://kurup.org/running">» Running</option>
    
  </select>
</fieldset>


<ul class="main-navigation">
  
  
  
  <li><a href="https://kurup.org/" title="Blog">Blog</a></li>
  
  
  
  <li><a href="https://kurup.org/about" title="About Me" >About Me</a></li>
  
  
  
  <li><a href="https://kurup.org/post" title="Archives" >Archives</a></li>
  
  
  
  <li><a href="https://kurup.org/categories" title="Categories" >Categories</a></li>
  
  
  
  <li><a href="https://kurup.org/medicine" title="Medicine" >Medicine</a></li>
  
  
  
  <li><a href="https://kurup.org/running" title="Running" >Running</a></li>
  
  
</ul>

<ul class="subscription">
  
  
  <a href="https://kurup.org/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss fa-lg"></i></a>
  
  
</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:https://kurup.org/" />
  </fieldset>
</form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Feb 16, 2006
     - 5 minute read 
    

    
    
      - <a class="label" href="https://kurup.org/categories/blog/">blog </a><a class="label" href="https://kurup.org/categories/openacs/">openacs </a><a class="label" href="https://kurup.org/categories/programming/">programming </a><a class="label" href="https://kurup.org/categories/web/">web </a>
    
  </p>
  <h1 class="entry-title">
     Creating a Blog Application using the OpenACS Content Repository 
  </h1>
</header>


        <div class="entry-content">
          
          
          
          <p>I created a very simple blog application using the OpenACS Content Repository (CR). When I say simple, I mean simple, probably to the point of being useless. I just wanted to try writing something as quickly as possible using the CR. Here&rsquo;s a quick run-through of the code, in case it might help someone else understand how to use the CR. I&rsquo;m not including much commentary; email me (or comment) if you&rsquo;d like me to expound more.</p>

<p>####blog.info</p>

<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt; 
&lt;!-- Generated by the OpenACS Package Manager --&gt;  
&lt;package key=&quot;blog&quot; url=&quot;http://openacs.org/repository/apm/packages/blog&quot; type=&quot;apm_application&quot;&gt;   
  &lt;package-name&gt;Blog&lt;/package-name&gt;
  &lt;pretty-plural&gt;Blogs&lt;/pretty-plural&gt;
  &lt;initial-install-p&gt;f&lt;/initial-install-p&gt;
  &lt;singleton-p&gt;f&lt;/singleton-p&gt;
  &lt;version name=&quot;0.1d&quot; url=&quot;http://openacs.org/repository/download/apm/blog-0.1d.apm&quot;&gt;
    &lt;owner url=&quot;mailto:admin@localhost&quot;&gt;Admin User&lt;/owner&gt;
    &lt;summary&gt;A blog application.&lt;/summary&gt;
    &lt;description format=&quot;text/html&quot;&gt;A simple Blog application using the Content Repository.&lt;/description&gt;
    &lt;maturity&gt;0&lt;/maturity&gt;
    &lt;provides url=&quot;blog&quot; version=&quot;0.1d&quot;/&gt;
    &lt;requires url=&quot;acs-content-repository&quot; version=&quot;5.2.2&quot;/&gt;
    &lt;callbacks&gt;
      &lt;callback type=&quot;after-install&quot;  proc=&quot;blog::apm::after_install&quot;/&gt;
      &lt;callback type=&quot;after-instantiate&quot;  proc=&quot;blog::apm::after_instantiate&quot;/&gt;
      &lt;callback type=&quot;before-uninstantiate&quot;  proc=&quot;blog::apm::before_uninstantiate&quot;/&gt;
      &lt;callback type=&quot;before-uninstall&quot;  proc=&quot;blog::apm::before_uninstall&quot;/&gt;
    &lt;/callbacks&gt;
    &lt;parameters&gt;
      &lt;!-- No version parameters --&gt;
    &lt;/parameters&gt;
  &lt;/version&gt;
&lt;/package&gt;
</code></pre>

<p>####tcl/blog-apm-procs.tcl</p>

<pre><code>namespace eval blog::apm {}

ad_proc -private blog::apm::after_install {} {
    Install the blog datamodel. 
} {     
    content::type::new -content_type blog_post \
        -pretty_name &quot;Blog Post&quot; \
        -pretty_plural &quot;Blog Posts&quot; \
        -table_name &quot;cr_blog_posts&quot; \
        -id_column &quot;post_id&quot; 
}  

ad_proc -private blog::apm::after_instantiate { -package_id } {
    Setup one instance of a blog. Creates a content folder and associate
    blog_posts with it. 
} {
    set folder_id [content::folder::new \
                       -name $package_id \
                       -label &quot;Blog Folder $package_id&quot; \
                       -package_id $package_id \
                       -context_id $package_id]

    content::folder::register_content_type \
        -folder_id $folder_id \
        -content_type &quot;blog_post&quot; \
        -include_subtypes &quot;t&quot; 
}  

ad_proc -private blog::apm::before_uninstantiate { -package_id } {
    Remove 1 instance of blog application. 
} {
    set folder_id [blog::folder_id $package_id]
    content::folder::delete -folder_id $folder_id -cascade_p t
    content::type::delete -content_type blog_post \
        -drop_children_p t \
        -drop_table_p t 
}  

ad_proc -private blog::apm::before_uninstall {} {
    Drop the application. 
} {
    content::type::delete -content_type blog_post \
        -drop_children_p t \
        -drop_table_p t 
} 
</code></pre>

<p>####tcl/blog-procs.tcl</p>

<pre><code>namespace eval blog {}

ad_proc -public blog::folder_id {package_id} {
    Return the CR folder_id associated with this package_id
    @param package_id Current package_id 
} {
    return [db_string get_folder_id &quot;select folder_id from cr_folders where package_id=:package_id&quot;] 
}
</code></pre>

<p>####www/index.tcl</p>

<pre><code>ad_page_contract {
    List posts
    @author Vinod Kurup [vinod@kurup.com]
    @creation-date Tue Feb 14 20:56:24 2006
    @cvs-id $Id:$ 
} { 
} {
    set package_id [ad_conn package_id]
    db_multirow posts posts &quot;
    select i.item_id,
           r.title,
           r.content,
           to_char(o.creation_date,'YYYY-MM-DD HH24:MI:SS') as creation_date,
           o.creation_user
     from cr_blog_posts p, cr_items i, cr_revisions r, acs_objects o
    where i.item_id=o.object_id
      and p.post_id=r.revision_id
      and o.package_id=:package_id
       and i.live_revision=p.post_id
    order by creation_date desc&quot;
} 
</code></pre>

<p>####www/index.adp</p>

<pre><code>&lt;master&gt;
  &lt;p&gt;&lt;a href=&quot;post/ae&quot;&gt;Add Post&lt;/a&gt;&lt;/p&gt;
  &lt;multiple name=&quot;posts&quot;&gt;
    &lt;include src=&quot;../lib/one-post&quot;
             item_id=&quot;@posts.item_id@&quot;
             title=&quot;@posts.title@&quot;
             content=&quot;@posts.content@&quot;
             creation_user=&quot;@posts.creation_user@&quot;
             creation_date=&quot;@posts.creation_date@&quot;
             /&gt;
  &lt;/multiple&gt;
</code></pre>

<p>####www/post/ae.tcl</p>

<pre><code>ad_page_contract {
      Add or edit a post
      @author Vinod Kurup [vinod@kurup.com]
      @creation-date Tue Feb 14 20:39:39 2006
      @cvs-id $Id:$ 
} {
    item_id:integer,optional 
} {
    set package_id [ad_conn package_id]
    set user_id [ad_conn user_id]
    set ip_addr [ad_conn peeraddr]
    permission::require_permission -object_id $package_id -privilege write
    set context [list &quot;Add/Edit Post&quot;]

    ad_form -name add_post -form {
        item_id:key(t_acs_object_id_seq)
        title:text(text)
        content:text(textarea) 
    } -select_query {
        select r.title, r.content
        from cr_items i, cr_revisions r
        where i.item_id=:item_id
        and i.live_revision=r.revision_id 
    } -edit_data {
        content::revision::new -item_id $item_id \
            -title $title \
            -content $content \
            -package_id $package_id \
            -is_live t

        ns_returnredirect .. 
    } -new_data {
        content::item::new -name &quot;Post $item_id&quot; \
            -item_id $item_id \
            -creation_user $user_id \
            -text $content \
            -package_id $package_id \
            -parent_id [blog::folder_id $package_id] \
            -creation_ip $ip_addr \
            -content_type &quot;blog_post&quot; \
            -title $title

        ns_returnredirect .. 
    }
</code></pre>

<p>####www/post/ae.adp</p>

<pre><code>&lt;master&gt;
  &lt;property name=&quot;title&quot;&gt;Add/Edit Post&lt;/property&gt;
  &lt;property name=&quot;context&quot;&gt;@context;noquote@&lt;/property&gt;

  &lt;formtemplate id=&quot;add_post&quot;&gt;&lt;/formtemplate&gt;
</code></pre>

<p>####www/post/del.tcl</p>

<pre><code>ad_page_contract {
    Delete a post
    @author Vinod Kurup [vinod@kurup.com]
    @creation-date Tue Feb 14 22:49:11 2006
    @cvs-id $Id:$ 
} {
    item_id:integer 
} {
    permission::require_permission -object_id $item_id -privilege write
    content::item::delete -item_id $item_id
    ns_returnredirect .. 
}
</code></pre>

<p>####www/post/view.tcl</p>

<pre><code>ad_page_contract {
    View one post
    @author Vinod Kurup [vinod@kurup.com]
    @creation-date Wed Feb 15 20:24:32 2006
    @cvs-id $Id:$ 
} {
    item_id:integer 
} {
    set package_id [ad_conn package_id] 
    set package_url [ad_conn package_url]
    db_0or1row post &quot; select i.item_id,
        r.title,
        r.content,
        to_char(o.creation_date,'YYYY-MM-DD HH24:MI:SS') as creation_date,
        o.creation_user
   from cr_blog_posts p, cr_items i, cr_revisions r, acs_objects o
  where i.item_id=o.object_id
    and p.post_id=r.revision_id
    and o.package_id=:package_id
     and i.live_revision=p.post_id
    and i.item_id=:item_id&quot;

    set context [list $title] 
</code></pre>

<p>####www/post/view.adp</p>

<pre><code>&lt;master&gt;
  &lt;property name=&quot;context&quot;&gt;@context;noquote@&lt;/property&gt;
  &lt;property name=&quot;title&quot;&gt;@title@&lt;/property&gt;

  &lt;include src=&quot;../../lib/one-post&quot;
           item_id=&quot;@item_id@&quot;
           title=&quot;@title@&quot;
           content=&quot;@content@&quot;
           creation_user=&quot;@creation_user@&quot;
           creation_date=&quot;@creation_date@&quot;
           /&gt;
</code></pre>

<p>####lib/one-post.tcl</p>

<pre><code>set package_url [ad_conn package_url]
set now [clock format [clock seconds] -format &quot;%Y-%m-%d %H:%M:%S&quot;]
set creation_date_pretty [util::age_pretty \
                              -timestamp_ansi $creation_date \
                              -sysdate_ansi $now]
set author [acs_community_member_link -user_id $creation_user]
set write_p [permission::permission_p -object_id $item_id -privilege write]
set perm_url [export_vars -base &quot;${package_url}post/view&quot; {item_id}]
</code></pre>

<p>####lib/one-post.adp</p>

<pre><code>&lt;div class=&quot;post&quot;&gt;
  &lt;h2&gt;&lt;a href=&quot;@perm_url@&quot;&gt;@title@&lt;/a&gt;&lt;/h2&gt;
  &lt;p class=&quot;byline&quot;&gt;
    Posted by @author;noquote@
    &lt;span class=&quot;date&quot;&gt;@creation_date_pretty@&lt;/span&gt;
  &lt;/p&gt;
  &lt;div class=&quot;content&quot;&gt;
    @content;noquote@
  &lt;/div&gt;
  &lt;p class=&quot;actions&quot;&gt;
    &lt;if @write_p@&gt;
      &lt;a href=&quot;@package_url@post/ae?item_id=@item_id@&quot;&gt;Edit&lt;/a&gt; |
      &lt;a href=&quot;@package_url@post/del?item_id=@item_id@&quot;&gt;Delete&lt;/a&gt;
    &lt;/if&gt;
  &lt;/p&gt;
&lt;/div&gt;
</code></pre>

<p>####Notes</p>

<p>You&rsquo;ll notice that there are no SQL datamodel files. Since I&rsquo;m using the CR, all of the datamodel is created by using the CR TCL API (specifically content::type::new). This package is subsite aware meaning you can install apps on multiple subsites and the data in each subsite will remain isolated from other subsites. It should uninstall itself cleanly since I&rsquo;ve written callbacks for before-uninstantiate and before-uninstall.</p>

<p>Like I said, this is very simplistic. You can create, read, update and delete posts, but that&rsquo;s about it. No commenting. No tags or categories. No RSS feeds. No search. But, since we&rsquo;ve used the CR as our base, I think it would be very easy to extend the app to do all those things. I&rsquo;m going to work on that, just for fun, of course. Thanks to <a href="http://www.thedesignexperience.org">Dave Bauer</a> for writing the TCL interface to the CR and for writing the wiki package which made me see the light about the benefits of using the CR.</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Vinod Kurup</span></span>
    
    <time>Feb 16, 2006</time>
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://kurup.org/blog/2006/02/14/friendship/" title="Friendship">Friendship</a>
    

    
      <a class="basic-alignment right" href="https://kurup.org/blog/2006/02/17/pound-update-kills-my-website/" title="Pound update kills my website">Pound update kills my website</a>
    
  </p>
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>

  

  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/vkurup/" title="https://github.com/vkurup/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/vkurup/" title="https://twitter.com/vkurup/"><i class="fa fa-twitter fa-3x"></i></a>
      
      <a target="_blank" href="https://keybase.io/vkurup/" title="https://keybase.io/vkurup/"><i class="fa fa-keybase fa-3x"></i></a> 
      
      
      <a target="_blank" href="https://stackoverflow.com/users/347942" title="https://stackoverflow.com/users/347942"><i class="fa fa-stack-overflow fa-3x"></i></a>
      
      
      
      
      

      
      
    </li>
  </ul>

  

  

  
  
  
  
  <section class="even">
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      
      
      
      <li class="post">
        <a href="/blog/2019/04/08/avik-730/">Avik 7:30</a>
      </li>
      
      
      
      
      
      <li class="post">
        <a href="/blog/2018/12/20/triangle-race-series/">Triangle Race Series</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2018/12/02/my-nest-journey/">My Nest Journey</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2018/09/23/composting/">Composting</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2018/09/22/starting-a-garden/">Starting a garden</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2018/05/31/history-of-indian-civilization/">History of Indian Civilization</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2018/05/30/autovacuum-not-running/">Autovacuum not running</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2018/05/29/renaissance-man/">Renaissance Man</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2014/07/28/using-dynamic-queries-in-a-cbv/">Using dynamic queries in a CBV</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2014/07/23/some-emacs-posts/">Some Emacs Posts</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2014/07/22/pygments-on-arch-linux/">Pygments on Arch Linux</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2014/07/21/how-to-create-test-models-in-django/">How to create test models in Django</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2013/01/21/peanut-allergy-a-personal-clinical-review/">Peanut Allergy, a personal clinical review</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2013/01/17/priorities-and-gtd/">Priorities and GTD</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2013/01/16/gtd-again/">GTD again?</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2013/01/15/writing-paralysis/">Writing paralysis</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2013/01/09/steal-my-web-app-idea/">Steal My Web App Idea</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2012/12/30/how-to-change-the-rear-tire-on-a-12-inch-bicycle/">How to change the rear tire on a 12 inch bicycle</a>
      </li>
      
      
      
      <li class="post">
        <a href="/blog/2012/11/05/nsbrief-gets-the-best-guests/">NSBrief gets the best guests</a>
      </li>
      
      
    </ul>
  </section>
  
  

  <section class="odd">
    <h1>My Pinboard</h1>
    <ul id="pinboard_linkroll">Fetching linkroll...</ul>
    <p><a href="http://pinboard.in/u:vkurup">My Pinboard Bookmarks &raquo;</a></p>
  </section>
  <script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; 
  var pinboard_user = "vkurup"; 
  var pinboard_count = 10; 
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/js/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
  </script>

</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2019 Vinod Kurup - <a href="https://kurup.org/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
      </p>
    </footer>

    
    
    

    
      <script>
        var _gaq=[['_setAccount','UA-79447-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
      </script>
    
  </body>
</html>

