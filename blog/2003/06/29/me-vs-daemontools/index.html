<!DOCTYPE HTML> 
<html>
   <head>
   <meta charset=utf-8> 
   <title>me vs. daemontools &larr; </title>
   <meta name="author" content="Vinod Kurup" />

   <link rel='openid.server' href='http://www.myopenid.com/server' />
   <link rel='openid.delegate' href='http://www.kurup.org' />

   <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="atom.xml" title="RSS feed" />
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/files/css/screen.css" type="text/css" />

</head>
<body id="">
<div id="site">

  <div id="header">
	<h1>
	<a href="/" title="My Personal Site">Vinod Kurup</a>
</h1>
<ul class="nav">
  <li><a class="home" href="/">Home</a></li>
  <li><a class="medicine" href="/medicine">Medicine</a></li>
  <li><a class="feed" href="/blog/atom.xml">Feed</a></li>
</ul>

  </div>

  <div id="page">
	
<h1 class="emphnext">me vs. daemontools</h1>


I have a love/hate relationship with <a href="http://cr.yp.to/daemontools.html">daemontools</a>. It's powerful way to manage services (like web servers and mail servers), but it sometimes doesn't act the way I expect it to. <br/>
<br/>
Today, I tried to set up <a href="http://cr.yp.to/qmail.html">qmail-pop3d</a>. I set up a directory called /var/qmail/supervise/qmail-pop3d and put a file named 'run' inside it. This contained:<br/>
<br/>
<pre><br/>
#!/bin/sh<br/>
PATH=/var/qmail/bin:/usr/local/sbin:/usr/local/bin:/usr/bin:/bin<br/>
export PATH<br/>
<br/>
tcpserver -H -R 0 pop-3 <br/>
/var/qmail/bin/qmail-popup vkurup.acornhosting.net <br/>
/home/vpopmail/bin/vchkpw /var/qmail/bin/qmail-pop3d Maildir &amp;<br/>
</pre><br/>
<br/>
Then I connected the run script to my /service directory<br/>
<pre><br/>
# ln -s /var/qmail/supervise/qmail-pop3d /service<br/>
</pre><br/>
<br/>
Then I checked to see if it was running:<br/>
<pre><br/>
# svstat /service/qmail-pop3d<br/>
/service/qmail-pop3d: up (pid 13524) 0 seconds<br/>
</pre><br/>
<br/>
Hmmm... up 0 seconds. That's not right - it should be at least 5 or 6 seconds (I can't type *that* fast). That usually means that the service is repeatedly failing and restarting itself.<br/>
<br/>
<p><br/>
ps shows that qmail-pop3d is running, but trying to connect to port 110 doesn't work:<br/>
</p><br/>
<pre><br/>
$ telnet localhost 110<br/>
Trying 127.0.0.1...<br/>
telnet: Unable to connect to remote host: Connection timed out<br/>
</pre><br/>
And now I'm stuck. Nothing is getting logged to the qmail-pop3d logs. After some headbanging, I do another ps -ax and this time notice a process called readproctitle:<br/>
<br/>
<pre><br/>
11919 ?        S      0:05 readproctitle service errors: ...lready used?tcpserve<br/>
r: fatal: unable to bind: address already used?tcpserver: fatal: unable to bind:<br/>
 address already used?tcpserver: fatal: unable to bind: address already used?tcp<br/>
server: fatal: unable to bind: address already used?tcpserver: fatal: unable to <br/>
bind: address already used?tcpserver: fatal: unable to bind: address already use<br/>
d?tcpserver: fatal: unable to bind: address already used?<br/>
</pre><br/>
<br/>
What's that? I look it up and find that <a href="http://cr.yp.to/daemontools/readproctitle.html">readproctitle</a> is a kind of scrolling-log for daemontools which shows up when you run ps. So, it looks like qmail-pop3d failing because it's trying to bind port 110 even though it's already been bound. So this makes me thing that qmail-pop3d isn't failing, but that it's running over and over again. And then I look back at my run script and look at that pesky little '&amp;' at the end. Doh! That tells the process to detach once it starts. It starts normally, then detaches. Once it detaches, daemontools thinks it's down, so it tries to start it again. (At least that's the way I understand it). Getting rid of the '&amp;' and adding 'exec' to the beginning fixes it and everything works now.<br/>
<br/>
<p><br/>
Me: 1 Daemontools: 2123<br/>
</p>


<address class="signature">
  <span class="author">&nbsp;</span>
  <span class="date">29 June 2003</span>
  <span class="tags"><a href="http://www.google.com/search?q=uncategorized+site:www.kurup.org" rel="tag">uncategorized</a>  </span>
</address>

  </div>
  
  <div id="footer">
	<address>
		<span class="copyright">
			Design by 
			<a href="http://mark.reid.name">Mark Reid</a>
			<br/>
			(<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
		</span>
		<span class="engine">
			Powered by 
			<a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
		</span>
	</address>
  </div>
</div>

<!-- Google Analytics script goes here -->
<!--<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1051817-4");
pageTracker._trackPageview();
</script>
-->
<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->
</body>
</html>
