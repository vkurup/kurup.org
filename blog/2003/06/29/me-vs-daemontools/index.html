<!DOCTYPE HTML> 
<html>
   <head>
   <meta charset=utf-8> 
   <title>me vs. daemontools &larr; </title>
   <meta name="author" content="Vinod Kurup" />

   <link rel='openid.server' href='http://www.myopenid.com/server' />
   <link rel='openid.delegate' href='http://www.kurup.org' />

   <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="atom.xml" title="RSS feed" />
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/files/css/screen.css" type="text/css" />

</head>
<body id="">
<div id="site">

  <div id="header">
	<h1>
	<a href="/" title="My Personal Site">Vinod Kurup</a>
</h1>
<ul class="nav">
  <li><a class="home" href="/">Home</a></li>
  <li><a class="medicine" href="/medicine">Medicine</a></li>
  <li><a class="feed" href="/blog/atom.xml">Feed</a></li>
</ul>

  </div>

  <div id="page">
	
<h1 class="emphnext">me vs. daemontools</h1>

<p>I have a love/hate relationship with <a href='http://cr.yp.to/daemontools.html'>daemontools</a>. It&#8217;s powerful way to manage services (like web servers and mail servers), but it sometimes doesn&#8217;t act the way I expect it to.</p>

<p>Today, I tried to set up <a href='http://cr.yp.to/qmail.html'>qmail-pop3d</a>. I set up a directory called <code>/var/qmail/supervise/qmail-pop3d</code> and put a file named &#8216;run&#8217; inside it. This contained:</p>

<pre><code>#!/bin/sh
PATH=/var/qmail/bin:/usr/local/sbin:/usr/local/bin:/usr/bin:/bin
export PATH

tcpserver -H -R 0 pop-3 
/var/qmail/bin/qmail-popup vkurup.acornhosting.net 
/home/vpopmail/bin/vchkpw /var/qmail/bin/qmail-pop3d Maildir &amp;</code></pre>

<p>Then I connected the run script to my /service directory</p>

<pre><code># ln -s /var/qmail/supervise/qmail-pop3d /service</code></pre>

<p>Then I checked to see if it was running:</p>

<pre><code># svstat /service/qmail-pop3d
/service/qmail-pop3d: up (pid 13524) 0 seconds</code></pre>

<p>Hmmm&#8230; up 0 seconds. That&#8217;s not right - it should be at least 5 or 6 seconds (I can&#8217;t type <strong>that</strong> fast). That usually means that the service is repeatedly failing and restarting itself.</p>

<p>ps shows that qmail-pop3d is running, but trying to connect to port 110 doesn&#8217;t work:</p>

<pre><code>$ telnet localhost 110
Trying 127.0.0.1...
telnet: Unable to connect to remote host: Connection timed out</code></pre>

<p>And now I&#8217;m stuck. Nothing is getting logged to the qmail-pop3d logs. After some headbanging, I do another <code>ps -ax</code> and this time notice a process called readproctitle:</p>

<pre><code>11919 ?        S      0:05 readproctitle service errors: ...lready used?tcpserve
r: fatal: unable to bind: address already used?tcpserver: fatal: unable to bind:
 address already used?tcpserver: fatal: unable to bind: address already used?tcp
server: fatal: unable to bind: address already used?tcpserver: fatal: unable to 
bind: address already used?tcpserver: fatal: unable to bind: address already use
d?tcpserver: fatal: unable to bind: address already used?</code></pre>

<p>What&#8217;s that? I look it up and find that <a href='http://cr.yp.to/daemontools/readproctitle.html'>readproctitle</a> is a kind of scrolling-log for daemontools which shows up when you run <code>ps</code>. So, it looks like <code>qmail-pop3d</code> failing because it&#8217;s trying to bind port 110 even though it&#8217;s already been bound. So this makes me thing that <code>qmail-pop3d</code> isn&#8217;t failing, but that it&#8217;s running over and over again. And then I look back at my run script and look at that pesky little &#8217;&amp;&#8217; at the end. Doh! That tells the process to detach once it starts. It starts normally, then detaches. Once it detaches, daemontools thinks it&#8217;s down, so it tries to start it again. (At least that&#8217;s the way I understand it). Getting rid of the &#8217;&amp;&#8217; and adding &#8216;exec&#8217; to the beginning fixes it and everything works now.</p>

<p>Me: 1 Daemontools: 2123</p>


<address class="signature">
  <span class="author">&nbsp;</span>
  <span class="date">29 June 2003</span>
  <span class="tags"><a href="http://www.google.com/search?q=daemontools+site:www.kurup.org" rel="tag">daemontools</a>  | <a href="http://www.google.com/search?q=sysadmin+site:www.kurup.org" rel="tag">sysadmin</a>  </span>
</address>

  </div>
  
  <div id="footer">
	<address>
		<span class="copyright">
			Design by 
			<a href="http://mark.reid.name">Mark Reid</a>, Content
			by <a href="mailto:vinod@kurup.com">Vinod Kurup</a>
			<br/>
			(<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
		</span>
		<span class="engine">
			Powered by 
			<a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
		</span>
	</address>
  </div>
</div>

<!-- Google Analytics script goes here -->
<!--<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1051817-4");
pageTracker._trackPageview();
</script>
-->
<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->
</body>
</html>
