<!DOCTYPE HTML> 
<html>
   <head>
   <meta charset=utf-8> 
   <title>Creating a Blog Application using the OpenACS Content Repository &larr; </title>
   <meta name="author" content="Vinod Kurup" />

   <link rel='openid.server' href='http://www.myopenid.com/server' />
   <link rel='openid.delegate' href='http://www.kurup.org' />

   <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="atom.xml" title="RSS feed" />
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/files/css/screen.css" type="text/css" />

</head>
<body id="">
<div id="site">

  <div id="header">
	<h1>
	<a href="/" title="My Personal Site">Vinod Kurup</a>
</h1>
<ul class="nav">
  <li><a class="home" href="/">Home</a></li>
  <li><a class="medicine" href="/medicine">Medicine</a></li>
  <li><a class="feed" href="/blog/atom.xml">Feed</a></li>
</ul>

  </div>

  <div id="page">
	
<h1 class="emphnext">Creating a Blog Application using the OpenACS Content Repository</h1>


<p> I created a very simple blog application using the OpenACS Content Repository (CR). When I say simple, I mean simple, probably to the point of being useless. I just wanted to try writing something as quickly as possible using the CR. Here's a quick run-through of the code, in case it might help someone else understand how to use the CR. I'm not including much commentary; email me (or comment) if you'd like me to expound more. </p>  <h4>blog.info</h4>  <pre> &lt;?xml version="1.0"?> &lt;!-- Generated by the OpenACS Package Manager -->  &lt;package key="blog" url="http://openacs.org/repository/apm/packages/blog" type="apm_application">     &lt;package-name>Blog&lt;/package-name>     &lt;pretty-plural>Blogs&lt;/pretty-plural>     &lt;initial-install-p>f&lt;/initial-install-p>     &lt;singleton-p>f&lt;/singleton-p>          &lt;version name="0.1d" url="http://openacs.org/repository/download/apm/blog-0.1d.apm">         &lt;owner url="mailto:admin@localhost">Admin User&lt;/owner>         &lt;summary>A blog application.&lt;/summary>         &lt;description format="text/html">A simple Blog application using the Content Repository.&lt;/description>         &lt;maturity>0&lt;/maturity>          &lt;provides url="blog" version="0.1d"/>         &lt;requires url="acs-content-repository" version="5.2.2"/>          &lt;callbacks>             &lt;callback type="after-install"  proc="blog::apm::after_install"/>             &lt;callback type="after-instantiate"  proc="blog::apm::after_instantiate"/>             &lt;callback type="before-uninstantiate"  proc="blog::apm::before_uninstantiate"/>             &lt;callback type="before-uninstall"  proc="blog::apm::before_uninstall"/>         &lt;/callbacks>         &lt;parameters>         &lt;!-- No version parameters -->         &lt;/parameters>      &lt;/version> &lt;/package>  </pre>  <h4>tcl/blog-apm-procs.tcl</h4>  <pre> namespace eval blog::apm {}  ad_proc -private blog::apm::after_install {} {      Install the blog datamodel. } {     content::type::new -content_type blog_post \         -pretty_name "Blog Post" \         -pretty_plural "Blog Posts" \         -table_name "cr_blog_posts" \         -id_column "post_id" }  ad_proc -private blog::apm::after_instantiate {     -package_id } {     Setup one instance of a blog. Creates a content folder and associate     blog_posts with it. } {     set folder_id [content::folder::new \                        -name $package_id \                        -label "Blog Folder $package_id" \                        -package_id $package_id \                        -context_id $package_id]      content::folder::register_content_type \         -folder_id $folder_id \         -content_type "blog_post" \         -include_subtypes "t" }  ad_proc -private blog::apm::before_uninstantiate {     -package_id } {     Remove 1 instance of blog application. } {     set folder_id [blog::folder_id $package_id]     content::folder::delete -folder_id $folder_id -cascade_p t     content::type::delete -content_type blog_post \         -drop_children_p t \         -drop_table_p t }  ad_proc -private blog::apm::before_uninstall {} {     Drop the application. } {     content::type::delete -content_type blog_post \         -drop_children_p t \         -drop_table_p t } </pre>  <h4>tcl/blog-procs.tcl</h4> <pre> namespace eval blog {}  ad_proc -public blog::folder_id {package_id} {     Return the CR folder_id associated with this package_id      @param package_id Current package_id } {     return [db_string get_folder_id "select folder_id from cr_folders where package_id=:package_id"] } </pre>  <h4>www/index.tcl</h4> <pre> ad_page_contract {      List posts      @author Vinod Kurup [vinod@kurup.com]      @creation-date Tue Feb 14 20:56:24 2006      @cvs-id $Id:$ } { }  set package_id [ad_conn package_id]  db_multirow posts posts "   select i.item_id,           r.title,          r.content,          to_char(o.creation_date,'YYYY-MM-DD HH24:MI:SS') as creation_date,          o.creation_user     from cr_blog_posts p, cr_items i, cr_revisions r, acs_objects o    where i.item_id=o.object_id      and p.post_id=r.revision_id      and o.package_id=:package_id       and i.live_revision=p.post_id    order by creation_date desc" </pre>  <h4>www/index.adp</h4> <pre> &lt;master>  &lt;p>&lt;a href="post/ae">Add Post&lt;/a>&lt;/p>  &lt;multiple name="posts">   &lt;include src="../lib/one-post"             item_id="@posts.item_id@"             title="@posts.title@"             content="@posts.content@"             creation_user="@posts.creation_user@"             creation_date="@posts.creation_date@" /> &lt;/multiple> </pre>  <h4>www/post/ae.tcl</h4> <pre> ad_page_contract {      Add or edit a post      @author Vinod Kurup [vinod@kurup.com]      @creation-date Tue Feb 14 20:39:39 2006      @cvs-id $Id:$ } {     item_id:integer,optional }  set package_id [ad_conn package_id] set user_id [ad_conn user_id] set ip_addr [ad_conn peeraddr]  permission::require_permission -object_id $package_id -privilege write  set context [list "Add/Edit Post"]  ad_form -name add_post -form {     item_id:key(t_acs_object_id_seq)     title:text(text)     content:text(textarea) } -select_query {     select r.title, r.content        from cr_items i, cr_revisions r       where i.item_id=:item_id         and i.live_revision=r.revision_id } -edit_data {     content::revision::new -item_id $item_id \         -title $title \         -content $content \         -package_id $package_id \         -is_live t      ns_returnredirect .. } -new_data {     content::item::new -name "Post $item_id" \         -item_id $item_id \         -creation_user $user_id \         -text $content \         -package_id $package_id \         -parent_id [blog::folder_id $package_id] \         -creation_ip $ip_addr \         -content_type "blog_post" \         -title $title      ns_returnredirect .. } </pre>  <h4>www/post/ae.adp</h4> <pre> &lt;master> &lt;property name="title">Add/Edit Post&lt;/property> &lt;property name="context">@context;noquote@&lt;/property>  &lt;formtemplate id="add_post">&lt;/formtemplate> </pre>  <h4>www/post/del.tcl</h4> <pre> ad_page_contract {      Delete a post      @author Vinod Kurup [vinod@kurup.com]      @creation-date Tue Feb 14 22:49:11 2006      @cvs-id $Id:$ } {     item_id:integer }  permission::require_permission -object_id $item_id -privilege write  content::item::delete -item_id $item_id  ns_returnredirect .. </pre>  <h4>www/post/view.tcl</h4> <pre> ad_page_contract {      View one post      @author Vinod Kurup [vinod@kurup.com]      @creation-date Wed Feb 15 20:24:32 2006      @cvs-id $Id:$ } {     item_id:integer }  set package_id [ad_conn package_id] set package_url [ad_conn package_url]  db_0or1row post " select i.item_id,         r.title,        r.content,        to_char(o.creation_date,'YYYY-MM-DD HH24:MI:SS') as creation_date,        o.creation_user   from cr_blog_posts p, cr_items i, cr_revisions r, acs_objects o  where i.item_id=o.object_id    and p.post_id=r.revision_id    and o.package_id=:package_id     and i.live_revision=p.post_id    and i.item_id=:item_id"   set context [list $title] </pre>  <h4>www/post/view.adp</h4> <pre> &lt;master> &lt;property name="context">@context;noquote@&lt;/property> &lt;property name="title">@title@&lt;/property>  &lt;include src="../../lib/one-post"           item_id="@item_id@"           title="@title@"           content="@content@"           creation_user="@creation_user@"           creation_date="@creation_date@" /> </pre>  <h4>lib/one-post.tcl</h4> <pre> set package_url [ad_conn package_url]  set now [clock format [clock seconds] -format "%Y-%m-%d %H:%M:%S"]  set creation_date_pretty [util::age_pretty \                               -timestamp_ansi $creation_date \                               -sysdate_ansi $now]  set author [acs_community_member_link -user_id $creation_user] set write_p [permission::permission_p -object_id $item_id -privilege write] set perm_url [export_vars -base "${package_url}post/view" {item_id}] </pre>  <h4>lib/one-post.adp</h4> <pre> &lt;div class="post">   &lt;h2>&lt;a href="@perm_url@">@title@&lt;/a>&lt;/h2>   &lt;p class="byline">     Posted by @author;noquote@     &lt;span class="date">@creation_date_pretty@&lt;/span>   &lt;/p>   &lt;div class="content">     @content;noquote@   &lt;/div>   &lt;p class="actions">     &lt;if @write_p@>      &lt;a href="@package_url@post/ae?item_id=@item_id@">Edit&lt;/a> |     &lt;a href="@package_url@post/del?item_id=@item_id@">Delete&lt;/a>     &lt;/if>   &lt;/p> &lt;/div> </pre>  <h4>Notes</h4>  <p> You'll notice that there are no SQL datamodel files. Since I'm using the CR, all of the datamodel is created by using the CR TCL API (specifically content::type::new). This package is subsite aware meaning you can install apps on multiple subsites and the data in each subsite will remain isolated from other subsites. It should uninstall itself cleanly since I've written callbacks for before-uninstantiate and before-uninstall.  </p>  <p> Like I said, this is very simplistic. You can create, read, update and delete posts, but that's about it. No commenting. No tags or categories. No RSS feeds. No search. But, since we've used the CR as our base, I think it would be very easy to extend the app to do all those things. I'm going to work on that, just for fun, of course. Thanks to <a href="http://www.thedesignexperience.org">Dave Bauer</a> for writing the TCL interface to the CR and for writing the wiki package which made me see the light about the benefits of using the CR. </p>


<address class="signature">
  <span class="author">&nbsp;</span>
  <span class="date">16 February 2006</span>
  <span class="tags"><a href="http://www.google.com/search?q=blog+site:www.kurup.org" rel="tag">blog</a>  | <a href="http://www.google.com/search?q=cr+site:www.kurup.org" rel="tag">cr</a>  | <a href="http://www.google.com/search?q=openacs+site:www.kurup.org" rel="tag">openacs</a>  | <a href="http://www.google.com/search?q=programming+site:www.kurup.org" rel="tag">programming</a>  | <a href="http://www.google.com/search?q=web+site:www.kurup.org" rel="tag">web</a>  </span>
</address>

  </div>
  
  <div id="footer">
	<address>
		<span class="copyright">
			Design by 
			<a href="http://mark.reid.name">Mark Reid</a>
			<br/>
			(<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
		</span>
		<span class="engine">
			Powered by 
			<a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
		</span>
	</address>
  </div>
</div>

<!-- Google Analytics script goes here -->
<!--<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1051817-4");
pageTracker._trackPageview();
</script>
-->
<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->
</body>
</html>
